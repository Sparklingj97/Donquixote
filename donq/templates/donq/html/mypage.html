<!doctype html>
{% load staticfiles%}
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width = device-width, initial-scale = 1.0, maximum-scale=1.0, minimum-scale = 1.0, user-scalable=no, target-densitydpi = medium-dpi" />
        <meta charset="utf-8" />
        <link rel="icon" type="image/png" href="{% static "img/favicon.png" %}">
        <link rel="stylesheet" type="text/css" href="{% static "css/main.css" %}"></link>
    <link rel="stylesheet" type="text/css" href="{% static "css/animate.css" %}"></link>
<link rel="stylesheet" type="text/css" href="{% static "css/mypage.css" %}"></link>
<link rel="stylesheet" type="text/css" href="{% static "css/progressbar.css" %}"></link>
<link rel="stylesheet" type="text/css" href="{% static "css/pw_change.css" %}"></link>
<script src="{% static "js/jquery-2.1.4.min.js" %}"></script>
<script src="{% static "js/jquery.cookie.js" %}"></script>
<script src="{% static "js/jquery.preimage.js" %}"></script>
<script src="http://malsup.github.com/jquery.form.js"></script>
<script type="text/javascript" src="{% static "js/skrollr.min.js" %}"></script>
<script tpye="text/javascript" src="{% static "js/mypage.js" %}"></script>
<script type="text/javascript">
    skrollr.init({
        smoothScrolling: false,
        mobileDeceleration: 0.004
    });
</script>
<script src="{% static "js/index.js" %}"></script>
<script type="text/javascript">
    window.addEventListener('load', function () {
        setTimeout(scrollTo, 0, 0, 1);
    }, false);
</script>
<script>
    $(document).ready(function () {
        $("#sidebar_right").hover(function () {
            $("#f_nav_category").css("backgroundColor", "rgba(0,0,0,0.3)");
            $("#f_nav_category").css("color", "white");
        }, function () {
            $("#f_nav_category").css("color", "#aeaeae");
        });
    });

    $(document).ready(function () {
        $("#f_nav_category").hover(function () {
            $("#f_nav_category").css("backgroundColor", "rgba(255,255,255,0.1)");
            $("#f_nav_category").css("color", "white");
        }, function () {
            $("#f_nav_category").css("backgroundColor", "transparent");
            $("#f_nav_category").css("color", "#aeaeae");
        });
    });
</script>
<title> DONQUIXOTE </title>
</head>

<body>

    <!-- 상단바 시작 -->
    <div id="topnav">
        <!-- 검색창 시작 -->
        <div id="search_sidebar">
            <input id="textfield" placeholder="검색" type="search" autocomplete="on"></input>
        <label id=search_img for="search_submit"></label>
        <input id="search_submit" type="submit"></input>
    </div>
<!-- 검색창 끝 -->

<div id="topbar_iconbox">
    <!-- 알림 아이콘 -->
    <a>
        <div id="btn_noti" onclick="showNoti()">
            <img class="topbar_icon noti" src="{% static "img/notification.png" %}">
            <img class="topbar_icon noti focused_noti" src="{% static "img/notification-focused.png" %}">
        </div>
    </a>
</div>

<!-- 알림 시작 -->

<div id="noti_container">
    <div class="noti_borderLine"></div>
    <div id="noti_content_container">
        <div class="noti_box">
            <div class="noti_box_content">
                <img src="1.jpg">
                <div class="note_box_content_text_container">
                    <font class="noti_text">승의님의 게시글에 댓글이 뿅하고 달렸습니다</font>
                    <br>
                    <font class="noti_date_text">오전 2:00</font>
                </div>
                <img src="1.jpg">
            </div>
            <div class="noti_box_undertext">
                <font class="noti_date_text">"글 댓글 댓글해"</font>
            </div>
        </div>

        <div class="noti_box">
            <div class="noti_box_content">
                <img src="1.jpg">
                <div class="note_box_content_text_container">
                    <font class="noti_text">승의님의 게시글에 댓글이 뿅하고 달렸습니다</font>
                    <br>
                    <font class="noti_date_text">오전 2:00</font>
                </div>
                <img src="1.jpg">
            </div>
            <div class="noti_box_undertext">
                <font class="noti_date_text">"글 댓글 댓글해"</font>
            </div>
        </div>
        <div class="noti_box">
            <div class="noti_box_content">
                <img src="1.jpg">
                <div class="note_box_content_text_container">
                    <font class="noti_text">승의님의 게시글에 댓글이 뿅하고 달렸습니다</font>
                    <br>
                    <font class="noti_date_text">오전 2:00</font>
                </div>
                <img src="1.jpg">
            </div>
            <div class="noti_box_undertext">
                <font class="noti_date_text">"글 댓글 댓글해"</font>
            </div>
        </div>
        <div class="noti_box">
            <div class="noti_box_content">
                <img src="1.jpg">
                <div class="note_box_content_text_container">
                    <font class="noti_text">승의님의 게시글에 댓글이 뿅하고 달렸습니다</font>
                    <br>
                    <font class="noti_date_text">오전 2:00</font>
                </div>
                <img src="1.jpg">
            </div>
            <div class="noti_box_undertext">
                <font class="noti_date_text">"글 댓글 댓글해"</font>
            </div>
        </div>

        <div class="noti_box">
            <div class="noti_box_content">
                <img src="1.jpg">
                <div class="note_box_content_text_container">
                    <font class="noti_text">승의님의 게시글에 댓글이 뿅하고 달렸습니다</font>
                    <br>
                    <font class="noti_date_text">오전 2:00</font>
                </div>
                <img src="1.jpg">
            </div>
            <div class="noti_box_undertext">
                <font class="noti_date_text">"글 댓글 댓글해"</font>
            </div>
        </div>

    </div>

    <div class="noti_borderLine"></div>
</div>
<!-- 알림 끝 -->

</div>
<!-- 상단바 끝 -->


<!-- 사이드바 시작 -->
<div id="sidebar">
    <!-- 왼쪽 사이드바 시작 -->
    <div id="sidebar_left">
        <!-- 사이드바 로고 -->
        <a href="{% url "main" %}"><img id="f_nav_logo" src="{% static "img/Logo.png" %}"></a>

        <!-- 프로필 정보 -->
        <div id="f_nav_profile_container">
            <div id="profileImgBox" style="background-image: url(/static/img/my-profile-photo.png)">
            </div>
            <h3 id="f_nav_profile_name">{{user.last_name}}</h3>
        </div>
        <!-- 프로필 정보 끝 -->

        <!-- 정렬방식 시작-->
        <div id="f_nav_sorttype">
            <input type="button" class="sorttype" value="레벨" onclick="clikedWriteButton()"></input>
        <input type="button" class="sorttype" value="내가 쓴 글" onclick="clikedPostButton()"></input>
</div>
<!-- 정렬방식 끝-->

<!-- 카테고리 시작 -->
<div id="f_nav_category" onclick="ClickedCat_mypage()">개인정보 변경
    <img id="arrow" src="{% static "img/category_arrow.png" %}">
</div>
<!-- 카테고리 시작 -->

<!-- Copyrights 시작 -->
<footer>
    <a href="../logout">
        <div id="profile_logout" style="cursor:pointer">로그아웃</div>
    </a>
</footer>
<!-- Copyrights 끝 -->
</div>
<!-- 왼쪽 사이드바 끝 -->



<!-- 오른쪽 사이드바 시작 -->
<div id="sidebar_right">
    <div class="category" onclick="mypage_change_pw()">비밀번호 변경</div>
    <div class="category" onclick="mypage_userdel()">회원 탈퇴</div>
</div>
<!-- 오른쪽 사이드바 끝 -->
</div>
<!-- 사이드바 끝 -->

<!-- newHTML 사이드바 배경 어둡게 하기-->
<div id="dim_sidebar_background" onclick="mypage_back()"></div>

<!-- 비밀번호 변경 팝업 시작 -->
<div id = "pw_card_container">
    <div id ="pw_card_title">
        <font class = "card_title_text">비밀번호 변경</font>
    </div>
    <div style="margin-top: 20px">
        <input class="change_pw_field" type="password" placeholder="기존 비밀번호 입력">
        <input class="change_pw_field" type="password" placeholder="새 비밀번호 입력">
        <input class="change_pw_field" type="password" placeholder="새 비밀번호 확인">
    </div>
    <div id = "btn_center">
        <input type = "button" value = "확인">
    </div>
</div>
<!-- 비밀번호 변경 팝업 끝 -->
<!-- 회원 탈퇴 팝업 시작 -->
<div id = "user_card_container">
    <div id ="user_card_title">
        <font class = "card_title_text">회원 탈퇴</font>
    </div>
    <div id = "text_container">
        정말 탈퇴하시겠습니까?<br>
        계정을 비록한 모든 정보가 삭제됩니다.<br>
        탈퇴하시려면 비밀번호를 입력해주세요.
    </div>
    <div style="margin-top: 20px">
        <input class="change_pw_field" type="password" placeholder="비밀번호 입력">
    </div>
    <div id = "btn_center">
        <input type = "button" value = "확인">
    </div>
</div>
<!-- 회원 탈퇴 팝업 끝 -->



<!-- 배경 어둡게 하기 -->
<div id="dim_background">
    <!-- 이미지 자세히 보기 시작 -->
    <div id="imageDetail">
        <img id="prevImgBtn" src="{% static "img/left_arrow.png" %}">
        <img id="nextImgBtn" src="{% static "img/right_arrow.png" %}">
        <img id="image_close" src="{% static "img/X.jpg" %}" width="20px" height="20px">
    </div>
    <!-- 이미지 자세히 보기 끝 -->
</div>
<!-- 배경 어둡게 하기 끝 -->

<!-- 컨텐츠 시작 -->
<div id="contents_container">

    <!--게시글 공간 띄우기-->
    <div id="mypage_contents_spacer"></div>


    <!-- 나의 정보/ 레벨 시작 -->
    <div class="posts_box">
        <!--  -->
        <div class="profile_pic_name_box">
            <label id="profile_update_img" for="Post_file"></label>
            <div id="crown"></div>
            
            <input type="file" id="Post_file" onchange="profile_post()" Postfilee_selected = "true" accept="image/*" >
            <div id="level_profile_pic" style="background-image: url('/static/img/my-profile-photo.png')"></div>
            <div id="profile_name">{{user.last_name}}</div>
        </div>
        <div id="level_bar_container">
            <div id="profile_level_text">LV 5</div>
            <div id="profile_level_bar">
                <div class="meter">
                    <span id="score" style="width: 2%"></span>
                    <div id="score_note"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- 나의 정보/ 레벨 끝 -->

    <!-- 포스팅 시작 -->
    {% for post in posts %}
    {% if user.username|stringformat:"s" == post.author|stringformat:"s" %}
    <div class="posts_box" id="box_{{post.timestamp}}"  popular="{{post.popular}}" trust="{{post.trust}}" chang="{{post.spear}}">
        <div class="post">
            <div id="downarrow" onclick="showPop(this)">
                <img src="{% static "img/arrow.png" %}" width="20px">
            </div>
            <div id="post_popup_container" onclick="showPop(this)">
                {% if user.username|stringformat:"s" == post.author|stringformat:"s" %}
                <a href=""><div class="popup_mypost">내가 쓴 글 수정</div></a>
                <a href="{% url "post_remove" post_id=post.pk %}"><div class="popup_mypost">내가 쓴 글 삭제</div></a>
                {% else %}
                <a><div class="popup_follow">{{post.author}}님을 팔로우</div></a>
                <a><div class="popup_follow">이 게시물을 보지 않습니다.</div></a>
                {% endif %}
            </div>
            <div class="box_intro">
                <img class="intro_img" src="{% static "img/profile.png" %}" width="70" height="70">
                <div class="intro_text">
                    <div class="text_name">{{post.author}}</div>
                    <div class="text_content">{{post.created_date}}</div>
                    <div class="comment_cat">| {{post.categori}} |</div>
                </div>
            </div>
            <div class="box_content">
                {{post.text}}
            </div>
            <div class="box_poto">

                {% for image in post.get_files%}
                <div class="photolist"><img class="poto_photolist" src="{{image}}"></div>
                {% endfor %}
                <div class="photolist" id="list_count"></div>
            </div>
            <div class="box_love">
                <div class="love_love">
                    <img class="love_img" src="{% static "img/heart.png" %}" width="35">
                    <div class="love_chang_text">{{post.viewer}}</div>
                </div>
                <div class="love_chang">
                    <img class="chang_img" src="{% static "img/spear.png" %}" width="35">
                    <div class="love_chang_text">{{post.spear}}</div>
                </div>
                <div class="love_chang">
                    <img class="chang_img" src="{% static "img/comment.png" %}" width="35">
                    <div class="love_chang_text" id="comment_count"></div>
                </div>
            </div>
        </div>
        </br>
    <hr />
    <div class="comment">
         <div class="comment_all">전체 댓글 보기</div>
        {% for comment in post.comments.all %}
                    <div class="comment_intro">
                        <img class="comment_image" src="{% static "img/profile.png" %}" width="60">
                        <div class="comment_ndc">
                            <div class="comment_name">{{comment.author}}</div>
                            <div class="comment_date">{{ comment.created_date }}</div>
                            <div class="comment_content">{{comment.text}}</div>
                        </div>
                    </div>
                     {% empty %}
                    <p>첫 번째 댓글러가 되어주세요!ㅎㅎ</p>
                    {% endfor %}
                    <!-- 댓글 입력 부분 시작 -->
                    <form action="/post/comment/" method=POST>
                          {% csrf_token %}

                        <div class="comment_write">
                            <input name = "post_id" style="display:none;" value="{{post.pk}}"/>
                            <div class="write_input">
                                <textarea class="write_textarea" placeholder="댓글입력" onkeydown="resize(this)" onkeyup="resize(this)" name="text"></textarea>
                            </div>
                            <button type="submit" style="background-color:rgba(0, 0, 0, 0);outline: 0;border:0;"><div class="write_submit">완료</div></button>
                        </div>
                    </form>
                </div>

            </div>
{% endif %}

{% endfor %}
    </div>

</div>

<!-- 포스팅 끝 -->
</div>
<!-- 컨텐츠 끝 -->

</body>
<script>
    window.onload=function(){
    var count=0;
    function upcount(){
        count++;
    }
    {% for post in posts %}
    {% if user.username|stringformat:"s" == post.author|stringformat:"s" %}
        upcount();
    {% endif %}
    {% endfor %}
    var level = 1;
    var score = (count)*30;
    var left = 0;
    var count = 0;
    var ep = [50, 200, 500, 1000, 2000, 5000, 10000, 15000, 20000, 30000];

    if(score > 29999){
        document.getElementById('crown').style.display = "inline-block";
    }

    if (score < ep[0]) {
        left = score / 0.5;
        if (score == 0)
            left = 1;

        document.getElementById('score_note').innerHTML = score + "/" + "50"

    } else {
        for (var i = 0; i < ep.length - 1; i++) {
            if (score > ep[i]) {
                level = i + 2;
                left = score - ep[i];
                document.getElementById('score_note').innerHTML = score + "/" + (ep[i + 1]);
                count = (ep[i + 1] - ep[i]) / 100;
                left = left / count;
                if (left < 1)
                    left = 1;
                if (score > 20000)
                    left = 100;
            } else if (score == ep[i])
                left = 100;
        }
    }
    document.getElementById('score').style.width = left + "%";
    document.getElementById('profile_level_text').innerHTML = "LV " + level;

    //프로그래스바
    $(function () {
        $(".meter > span").each(function () {
            $(this)
                .data("origWidth", $(this).width())
                .width(1 + "%")
                .animate({
                width: $(this).data("origWidth")
            }, 1500);
        });
    });
    $("#score_note").animate({
        left: (document.getElementById('score').clientWidth - 26)
    }, 1500);

    document.getElementById('profile_level_bar').addEventListener('mouseover', function () {
        document.getElementById('score_note').style.opacity = "0.8";
    })

    document.getElementById('profile_level_bar').addEventListener('mouseout', function () {
        document.getElementById('score_note').style.opacity = "0";
    })

    var box = document.getElementsByClassName('box_poto');

    for (var i = 0; i < box.length; i++) {
        clearWhiteElement(box[i]);
    }
    for (var i = 0; i < box.length; i++) {
        var image = [];

        for (var j = 0; j < box[i].childNodes.length; j++) {
            image[j] = box[i].childNodes[j].firstChild;
        }
        PhotoList(image);
    }

    var image_count=0;
    // 올린 사진 리스트
    function PhotoList(obj) {
        console.log(obj.length);
        if (obj.length > 2 && obj.length <= 4) {
            for (var i = 0; i < obj.length-1; i++) {
                obj[i].parentNode.style.width = "180px";
                obj[i].parentNode.style.height = "180px";
                obj[i].style.width = "180px";
                obj[i].style.height = "180px";
            }

        } else if (obj.length >= 5) {
            var count = 0;
            for (var i = 0; i < obj.length-1; i++) {
                obj[i].parentNode.style.width = "180px";
                obj[i].parentNode.style.height = "180px";
                obj[i].style.width = "180px";
                obj[i].style.height = "180px";
                if (i > 2) {
                    count++;
                    obj[i].parentNode.style.display = "none";
                    obj[i].parentNode.parentNode.lastChild.style.display = "inline-block";
                    obj[i].parentNode.parentNode.lastChild.innerHTML = "+" + (count);
                }
            }

        } else if (obj.length == 2) {
            if (obj[0].clientWidth > obj[0].parentNode.parentNode.clientHeight) {
                obj[0].style.width = obj[0].parentNode.parentNode.clientWidth + "px";
            }

            if (obj[0].clientWidth >= 700) {
                obj[0].style.width = obj[0].parentNode.parentNode.clientWidth + "px";
            }
        }
        // 이미지 슬라이드

        // 이미지 open
        for (var i = 0; i < obj.length-1; i++) {
            obj[i].addEventListener('click', open,false);
        }

        function open() {
            for (var i = 0; i < obj.length; i++) {
                if (this == obj[i])
                    image_count = i;
            }
            document.getElementById('dim_background').style.display = "block"
            document.getElementById('imageDetail').style.backgroundImage = "url(" + this.src; + ")"
            clearWhiteElement(this.parentNode.parentNode);
            //   prevImgBtn , nextImgBtn
            var temp=this;
            document.getElementById('prevImgBtn').addEventListener('click', function () {
                document.getElementById('imageDetail').style.backgroundImage = "url(" + temp.parentNode.previousSibling.firstChild.src; + ")"
            })

            document.getElementById('nextImgBtn').addEventListener('click', function () {
                document.getElementById('imageDetail').style.backgroundImage = "url(" + temp.parentNode.nextSibling.firstChild.src; + ")"
            })

            // 이미지 close
            document.getElementById('image_close').addEventListener('click', function () {
                document.getElementById('dim_background').style.display = "none"
            })
        }
    }

     
    function clearWhiteElement(elem){

        elem = elem || document;

        var childs = elem.childNodes
        , length = childs.length;

        for (var i = 0; i < length; i++){

            var child = childs[i];

            if (child)
            {
                if (child.nodeType === 3 && !/\S/.test(child.nodeValue)){
                    elem.removeChild(child);
                }
                else if(child.nodeType === 1)
                {
                    clearWhiteElement(child);
                }
            }
            else{
                var n = next(elem);
                if (n) clearWhiteElement(n);
            }
        }
    }
    function next(elem){

        do{
            elem = elem.nextSibling;
        }
        while(elem && elem.nodeType !== 1)

            return elem;

    }
    var comment = document.getElementsByClassName('comment');
    var comment_count = 0;

    for (var i = 0; i <comment.length; i++) {
        for(var j =0;j<comment[i].childNodes.length;j++){
            if(comment[i].childNodes[j].className == "comment_intro")
                comment_count++;
        }
        clearWhiteElement(comment[i].parentNode);
        clearWhiteElement(comment[i].parentNode.childNodes[0]);
        clearWhiteElement(comment[i].parentNode.childNodes[0].childNodes[5]);
        clearWhiteElement(comment[i].parentNode.childNodes[0].childNodes[5].childNodes[2]);
        comment[i].parentNode.childNodes[0].childNodes[5].childNodes[2].childNodes[1].innerHTML = comment_count;
        comment_count = 0;
    }
    }
</script>

</html>